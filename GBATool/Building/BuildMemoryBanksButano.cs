using ArchitectureLibrary.Model;
using GBATool.Enums;
using GBATool.FileSystem;
using GBATool.Models;
using GBATool.Utils;
using GBATool.VOs;
using System;
using System.Collections.Generic;
using System.IO;
using System.Threading.Tasks;

namespace GBATool.Building;

using TileBlocks = (int width, int height, int numberOfTiles);

public sealed class BuildMemoryBanksButano : Building<BuildMemoryBanksButano>
{
    protected override string FileName { get; } = string.Empty;
    protected override OutputFormat OutputFormat { get; } = OutputFormat.Butano;

    protected override async Task<bool> DoGenerate()
    {
        ProjectModel projectModel = ModelManager.Get<ProjectModel>();

        string outputPath = Path.GetFullPath(projectModel.Build.GeneratedAssetsPath);

        List<FileModelVO> bankModelVOs = ProjectFiles.GetModels<BankModel>();

        int processedCount = 0;

        foreach (FileModelVO vo in bankModelVOs)
        {
            if (vo.Model is not BankModel bank)
            {
                continue;
            }

            if (string.IsNullOrEmpty(vo.Name))
            {
                continue;
            }

            BitsPerPixel bpp = bank.Use256Colors ? BitsPerPixel.f8bpp : BitsPerPixel.f4bpp;

            TileBlocks cellsCount = bank.GetBoundingBoxSize();

            int imageWidth = cellsCount.width * BankUtils.SizeOfCellInPixels;
            int imageHeight = cellsCount.height * BankUtils.SizeOfCellInPixels;

            BankImageMetaData metaData = BankUtils.CreateImage(bank, false, imageWidth, imageHeight);

            if (metaData.image == null)
            {
                continue;
            }

            string fileName = Path.Combine(outputPath, "bank_" + vo.Name.ToLower());

            using StreamWriter outputFile = new(Path.Combine(fileName + ".h"));

            await WriteHeader(outputFile, vo.Name);

            //List<Color> palette = [];
            //
            //bool ret = GetPaletteIfExistInCharacters(bank, ref palette);
            //
            //if (!ret)
            //{
            //    AddWarning($"No palette configure for bank [{vo.Name}], is going to be skipped");
            //    continue;
            //}
            //
            //byte[]? imageData = null;
            //
            //using (metaData.image.GetBitmapContext())
            //{
            //    try
            //    {
            //        List<string> warnings = [];
            //
            //        imageData = ImageProcessing.ConvertToXbpp(bpp, in metaData.image, in cellsCount, in palette, ref warnings);
            //
            //        foreach (string item in warnings)
            //        {
            //            AddWarning($"{vo.Name}, " + item);
            //        }
            //    }
            //    catch (Exception e)
            //    {
            //        AddError(e.Message);
            //        continue;
            //    }
            //
            //    if (imageData == null)
            //    {
            //        AddError("Could not convert the image from the bank to the bit per pixel requested");
            //        continue;
            //    }
            //}

            await WriteFooter(outputFile, vo.Name);

            processedCount++;
        }

        if (processedCount == 0)
        {
            AddError("No banks processed");
        }

        return GetErrors().Length == 0;
    }

    private static async Task WriteHeader(StreamWriter outputFile, string name)
    {
        List<string> header = Util.GetAutoGeneratedHeaderInfo("//");

        foreach (string item in header)
        {
            await outputFile.WriteLineAsync(item);
        }

        await outputFile.WriteAsync(Environment.NewLine);

        await outputFile.WriteLineAsync($"#ifndef GBATOOL_SPRITE_{name.ToUpper()}");
        await outputFile.WriteLineAsync($"#define GBATOOL_SPRITE_{name.ToUpper()}");

        await outputFile.WriteAsync(Environment.NewLine);
    }

    private static async Task WriteFooter(StreamWriter outputFile, string name)
    {
        await outputFile.WriteAsync(Environment.NewLine);

        await outputFile.WriteLineAsync($"#endif // GBATOOL_SPRITE_{name.ToUpper()}");
    }
}
